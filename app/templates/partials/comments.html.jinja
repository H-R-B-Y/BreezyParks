
<div>
<!-- Implement lazy loading here later for large comment bases? -->
<!-- Add like counter? -->
	<div class="w3-container w3-auto">
		<div class="w3-cell-row" style="margin-bottom:10px;border-bottom:solid #e6d7ff;">
			<div class="w3-cell w3-left-align">
				<a class="w3-large">Comments</a>
			</div>
			{% if current_user.is_authenticated %}
			<div class="w3-cell w3-right-align">
				<button class="w3-button my-hover-lilac" onclick="show_add_comment_area()">Add Comment</button>
			</div>
			{% endif %}
		</div>
		<div class="w3-container w3-content">
			{% if current_user.is_authenticated %}
			<div id="add_comment_area" class="w3-container" style="display:none;border-radius:15px;outline:solid #1f2122;margin-bottom:15px;box-shadow:0 2px 5px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12);">
			<form id="new_comment_form">
				<textarea id="new_comment_body" class="simple_textarea"> </textarea>
				<button type="submit" id="new_comment_send_button" class="w3-button my-hover-lilac" style="width:100%;">Post Comment</button>
			</form>
			<div id="error_message" style="color: red;display: none;"> </div>
			</div>
			{% endif %}
			{% for comment in getComments(page_type, thing_id) %}
			<div class="w3-container" style="border-radius:15px;outline:solid #1f2122;margin-bottom:15px;box-shadow:0 2px 5px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12);">
			<div class="w3-cell-row">
				<div class="w3-cell"><a class="w3-small" href="{{Users.get_user_by_id(comment.user_id).username}}/profile">{{Users.get_user_by_id(comment.user_id).username}}</a></div>
				{% if current_user.is_authenticated %}
				<div class="w3-small w3-cell w3-right-align"><a id="comment-{{ comment.id }}" href="javascript:bp_toggle_like_on_item('comment-{{ comment.id }}', 'comment', {{ comment.id}})">{% if UserLikedThis(current_user.id, "comment", comment.id) %}Unlike{% else %}Like{% endif%}</a></div>
				{% endif %}
			</div>
			<div class="w3-content">
			<p>{{comment.body}}</p>
			</div>
			<!-- Need to find best way to add replies to the DOM when returned from endpoint -->
			{% if CommentHasReplies(comment.id) == True %}
			<div class="w3-cell-row"  style="margin-bottom:5px;">
				<div class="w3-cell w3-small w3-right-align w3-cell-bottom">
				<a href="#">Load replies</a>
				</div>
			</div>
			{% endif %}
			</div>
			{% endfor %}
		</div>
	</div>
<script>
function show_add_comment_area()
{
	let comment_area = document.getElementById("add_comment_area");
	if (comment_area.style.display == "none")
	{comment_area.style.display = "block";}
	else {comment_area.style.display = "none";};
};

{% if current_user.is_authenticated %}
document.getElementById("new_comment_form").addEventListener("submit", async function(event)
{
	console.log("Here");
	event.preventDefault();
	const comment = document.getElementById("new_comment_body").value.trim();
	const error_container = document.getElementById("error_message");
	if (!comment)
	{
		error_container.style.display = "block";
		error_container.textContent = "Please enter a comment";
		return ;
	}
	if (comment.length >= 256)
	{
		error_container.style.display = "block";
		error_container.textContent = "Comment can be a maximum of 256 characters."
		return ;
	}
	error_container.style.display = "none";
	const endpoint = "/post_comment";
	const formData = new FormData();
	formData.append("comment_body", comment);
	formData.append("comment_on_type", "thing");
	formData.append("comment_on_id", "{{ thing_id }}");
	try
	{
		const response = await fetch(endpoint, {method: "POST", body: formData});
		if (response.ok)
		{
			const result = await response.json();
			if (result.status === "ok"){location.reload();}
			else{error_container.style.display = "block";error_container.textContent = "Issue posting comment: " + result.status;};
		}
		else{throw new Error("Network response was not ok");};
	}
	catch (error){error_container.style.display = 'block';error_container.textContent = 'Error submitting the form: ' + error.message;}
});
{% endif %}
</script>
</div>
